<script src="{{{uiRootPath}}}/js/site.js"></script>
<script async src="{{{uiRootPath}}}/js/vendor/highlight.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic@1.19.2/dist/theme.min.css"
  integrity="sha256-4Wtj6dqgMBT/Ji+vI49GON0NbfDlaJH06SUD7TH4yYg="
  crossorigin="anonymous"
/>
<script src="https://cdn.jsdelivr.net/npm/algoliasearch@5.30.0/dist/lite/builds/browser.umd.js" integrity="sha256-w/rbJ5CGTW5rub22bQ/VEoIHxypNh4NZPdkIJvGMZlI=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.79.0/dist/instantsearch.production.min.js" integrity="sha256-FOU2owonNoOmNxF4I8jLR4D8w/vziYNi64GUN2boXRQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js@1"></script>

<script>
  const { autocomplete, getAlgoliaResults, getAlgoliaFacets } = window['@algolia/autocomplete-js'];
  const { liteClient: algoliasearch } = window['algoliasearch/lite'];

  window.SELECTED_FACETS = {};

  const getFacetFilters = () => {
    return Object.keys(window.SELECTED_FACETS)
      .reduce((acc, key) => {
        const values = Object.keys(window.SELECTED_FACETS[key])
          .filter(value => window.SELECTED_FACETS[key][value])
          .map((value) => `${key}:${value}`);
        acc.push(...values);
        return acc;
      }, []);
  };

  const updateFacetState = (facets) => {
    const newState = {};
    Object.keys(facets).forEach(key => {
      newState[key] = {};
      Object.keys(facets[key]).forEach(name => {
        newState[key][name] = window.SELECTED_FACETS[key]?.[name] || false;
      });
    });
    window.SELECTED_FACETS = newState;
  };

  const searchClient = algoliasearch('{{site.keys.docsearchId}}', '{{site.keys.docsearchApi}}');

  const {
    refresh,
  } = autocomplete({
    container: '#search-input',
    placeholder: 'Search',
    openOnFocus: true,
    defaultActiveItemId: 0,
    getSources({ query }) {
      return [
        {
          sourceId: 'algolia',
          getItems() {
            return getAlgoliaResults({
              searchClient,
              transformResponse({ results, hits }) {
                updateFacetState(results[0]?.facets || {});
                return hits;
              },
              queries: [
                {
                  indexName: '{{site.keys.docsearchIndex}}',
                  params: {
                    query,
                    hitsPerPage: 5,
                    facets: ['product', 'version'],
                    facetFilters: getFacetFilters(),
                    attributesToSnippet: ['title:10', 'content:35'],
                    snippetEllipsisText: 'â€¦',
                  },
                },
              ],
            });
          },
          templates: {
            header({ html }) {
              return Object.keys(window.SELECTED_FACETS).length > 0 ? html`
                <div class="facet-filters">
                  ${Object.keys(window.SELECTED_FACETS).map(key =>
                    html`<h4 class="capitalize">${key}</h4>
                   <ul>
                     ${Object.keys(window.SELECTED_FACETS[key]).map(name => {
                       const isChecked = window.SELECTED_FACETS[key] && window.SELECTED_FACETS[key][name] === true;
                       console.log(`Rendering ${key}:${name}, isChecked: ${isChecked}, value: ${window.SELECTED_FACETS[key] && window.SELECTED_FACETS[key][name]}`);

                       return html`<li>
                           <label>
                             ${isChecked ? html`<input
                               type="checkbox"
                               name="${key}"
                               id="${name}"
                               data-facet-key="${key}"
                               data-facet-value="${name}"
                               checked
                             />` : html`<input
                               type="checkbox"
                               name="${key}"
                               id="${name}"
                               data-facet-key="${key}"
                               data-facet-value="${name}"
                             />`}
                             ${name}
                           </label>
                         </li>`;
                     })}
                   </ul>`
                  )}
                </div>
              ` : html``;
            },
            item({ item, components, html }) {
              return html`
              <div class="aa-ItemWrapper">
                <div class="aa-ItemContent">
                  <div class="aa-ItemIcon">
                    <!-- @TODO: differentiate between icons -->
                    <svg xmlns="http://www.w3.org/2000/svg"  width="100" height="100"
                         viewBox="0 0 100 100" xml:space="preserve">
                      <g>
                        <g>
                          <path d="M32,59h13c1.1,0,2-0.9,2-2V27c0-2.2-2-4-4-4H32.3C31,23,30,24,30,25.3V55v2C30,58.1,30.9,59,32,59z"/>
                        </g>
                        <g>
                          <path d="M76,29v32c0,2.2-1.8,4-4,4H28c-2.2,0-4-1.8-4-4V29c-3.3,0-6,2.7-6,6v30c0,3.3,2.7,6,6,6h19c1.1,0,2,0.9,2,2v0
                            c0,1.1,0.9,2,2,2h6c1.1,0,2-0.9,2-2v0c0-1.1,0.9-2,2-2h19c3.3,0,6-2.7,6-6V35C82,31.7,79.3,29,76,29z"/>
                        </g>
                        <g>
                          <path d="M55,59h12.7c1.3,0,2.3-1,2.3-2.3V55V25c0-1.1-0.9-2-2-2H57c-2,0-4,1.8-4,4v30C53,58.1,53.9,59,55,59z"/>
                        </g>
                      </g>
                    </svg>
                  </div>
                  <a class="aa-ItemLink" href="${item.url+item.anchor}" target="_self">
                    <div class="aa-ItemContentBody">
                      <h4 class="aa-ItemContentTitle">
                        ${components.Highlight({ hit: item, attribute: 'title' })}
                      </h4>
                      <p class="aa-ItemContentDescription">
                        ${components.Snippet({ hit: item, attribute: 'content' })}
                      </p>
                    </div>
                  </a>
                </div>
              </div>`;
            },
            noResults({ html }) {
              return html`<p class="search-no-results">No results found.</p>`;
            },
          },
          getItemUrl({ item }) {
            return item.url;
          },
        },
      ];
    },
    // render({ children, render }, root) {
    //   console.log(root);
    //   render(children, root);
    // },
  });

  document.addEventListener('change', function(event) {
    if (event.target.type === 'checkbox' && event.target.dataset.facetKey) {
      const facetKey = event.target.dataset.facetKey;
      const facetValue = event.target.dataset.facetValue;

      window.SELECTED_FACETS[facetKey][facetValue] = event.target.checked;

      if (refresh) {
        refresh();
      }
    }
  });
</script>

<script>
  // Mobile Menu
  document.addEventListener('DOMContentLoaded', function () {
    const burger = document.getElementById('burger');
    const menu = document.getElementById('menu-holder');
    const closeBtn = document.getElementById('menu-close');

    if (burger && menu && closeBtn) {
      burger.addEventListener('click', function () {
        menu.classList.add('active');
        burger.style.display = 'none';
        document.body.style.overflow = 'hidden';
      });

      closeBtn.addEventListener('click', function () {
        menu.classList.remove('active');
        burger.style.display = 'flex';
        document.body.style.overflow = '';
      });

      // Reset burger on resize
      window.addEventListener('resize', function () {
        if (window.innerWidth > 1100) {
          burger.style.display = ''; // Remove inline style so CSS takes over
          menu.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>
<script>
  feather.replace();
</script>
